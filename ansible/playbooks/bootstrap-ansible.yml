---
- name: Bootstrap the Ansible user
  hosts: pi_plane
  gather_facts: true
  remote_user: ubuntu
  vars:
    public_key_path: "{{ lookup('env','HOME') + '/.ssh/id_ed25519.pub' }}"
  tasks:
    - name: Create ansible user with sudo
      user:
        name: ansible
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes

    - name: Copy public key to ansible user
      authorized_key:
        user: ansible
        key: "{{ lookup('file', public_key_path) }}"
        state: present

    - name: Create sudoers file for passwordless sudo
      copy:
        dest: /etc/sudoers.d/ansible
        content: "ansible ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: '0440'

    - name: Ensure ansible home & .ssh folder exist
      file:
        path: /home/ansible/.ssh
        state: directory
        owner: ansible
        group: ansible
        mode: '0700'

    - name: Ensure Ansible remote tmp dir exists
      file:
        path: /home/ansible/.ansible/tmp
        state: directory
        owner: ansible
        group: ansible
        mode: '0700'

